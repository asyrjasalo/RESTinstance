version: 2

jobs:
  atest:
    machine:
      docker_layer_caching: true

    steps:
      - checkout

      - run:
          name: make install atest
          command: make install atest

      - store_test_results:
          path: results/

      - store_artifacts:
          path: results/


  all_github:
    machine:
      docker_layer_caching: true

    steps:
      - checkout

      - run:
          name: Install libssl
          command: sudo apt update && sudo apt install --yes libssl-dev

      - run:
          name: Pyenv upgrade Python version list
          command: cd /opt/circleci/.pyenv/plugins/python-build/../.. && git pull && cd -

      - run:
          name: Install Python 3.7.4
          command: pyenv install 3.7.4

      - run:
          name: Use Python 3.7.4
          command: pyenv shell 3.7.4

      - run:
          name: make black test build install atest
          command: make all_github

      - store_test_results:
          path: results/

      - store_artifacts:
          path: results/


  all_prepypi:
    docker:
      - image: circleci/python:3.7

    steps:
      - checkout

      - run:
          name: make build publish_pre install_pre atest
          command: make all_prepypi

      - store_test_results:
          path: results/

      - store_artifacts:
          path: results/


  all_pypi:
    docker:
      - image: circleci/python:3.7

    steps:
      - checkout

      - run:
          name: make build publish_prod install_prod atest
          command: make all_pypi

      - store_test_results:
          path: results/

      - store_artifacts:
          path: results/

workflows:
  version: 2
  make:
    jobs:
      - all_github
